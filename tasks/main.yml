- name: Update repositories cache (--extra-vars="forceupdate=true" if newer than 1 day)
  become: true
  apt:
    update_cache: yes
    # one day
    cache_valid_time:  "{{ (forceupdate | bool == true) | ternary('0','86400') }}"

- name: Check whether there are packages available to be installed/upgraded
  command: apt list --upgradable
  changed_when: false
  register: packages
- name: Output updateable packages
  when: "packages.stdout != 'Listing...' and packages.stdout != 'Auflistung...'"
  changed_when: true
  debug:
    var: packages.stdout_lines
  register: updateavailable

- name: Check manually held packages
  tags: upgrade
  command: apt-mark showhold
  register: heldpackages
  changed_when: false
  failed_when: "holdpackage is defined and heldpackages.stdout_lines|join(',')  != holdpackage"
- name: Output manually held packages
  when: "heldpackages.stdout == '' and holdpackage is defined or heldpackages.stdout != '' and holdpackage is defined and heldpackages.stdout_lines|join(',')  != holdpackage"
  changed_when: true
  debug:
    var: heldpackages.stdout_lines

- name: dist-upgrade packages (--extra-vars="upgrade=true")
  tags: upgrade
  become: true
  when: upgrade | bool and (packages is not defined or updateavailable.changed)
  register: upgraded
  apt:
    upgrade: dist
- name: show upgraded
  tags: upgrade
  when: upgrade | bool and upgraded.changed
  debug:
    msg: "{{upgraded.stdout_lines}}"

- name: Autoremove
  tags: cleanup
  become: true
  apt:
    autoremove: yes
- name: Autoclean
  tags: cleanup
  become: true
  apt:
    autoclean: yes

- name: Reboot is required if changed
  tags: reboot
  stat:
    path: /var/run/reboot-required
    get_md5: no
  register: rebootrequired
  changed_when: "rebootrequired.stat.exists == true"

- name: Reboot (--extra-vars="reboot=true")
  tags: reboot
  when: reboot | bool == true and rebootrequired.stat.exists == true
  become: true
  reboot:
    connect_timeout: 10
    reboot_timeout: 5
  ignore_errors: yes
  register: reboot_result
- name: wait for connection
  when: reboot_result is defined and reboot_result.skipped != true
  wait_for_connection:
    delay: 3
    timeout: 120
- name: reboot result
  tags: reboot
  when: reboot_result is defined and reboot_result.skipped != true
  debug:
    msg: "{{reboot_result}}"
